<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cookieè¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #fff;
      padding: 40px 20px;
      min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 {
      font-size: 32px;
      margin-bottom: 20px;
      text-align: center;
      background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.9) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
    }
    .status-box {
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.8;
    }
    .status-ok {
      background: rgba(76,175,80,0.1);
      border: 2px solid #4CAF50;
    }
    .status-warning {
      background: rgba(255,193,7,0.1);
      border: 2px solid #FFC107;
    }
    .status-error {
      background: rgba(244,67,54,0.1);
      border: 2px solid #f44336;
    }
    button {
      width: 100%;
      padding: 14px 24px;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 10px 0;
    }
    button:hover:not(:disabled) {
      background: #1976D2;
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .cookie-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 12px;
    }
    .cookie-table th {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    .cookie-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .cookie-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-ok { background: #4CAF50; color: #fff; }
    .badge-expired { background: #f44336; color: #fff; }
    .badge-missing { background: #FF9800; color: #fff; }
    code {
      background: rgba(0,0,0,0.3);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    pre {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.6;
    }
    .section-title {
      font-size: 20px;
      color: #b0b0b0;
      margin: 30px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .checklist {
      list-style: none;
      margin: 15px 0;
    }
    .checklist li {
      padding: 10px;
      margin: 8px 0;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid transparent;
    }
    .checklist li.ok { border-left-color: #4CAF50; }
    .checklist li.error { border-left-color: #f44336; }
    .checklist li.warning { border-left-color: #FFC107; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Cookieè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="card">
      <h2 style="margin-bottom: 15px; color: #b0b0b0;">ğŸ“Š ã‚µãƒ¼ãƒãƒ¼å´CookieçŠ¶æ…‹</h2>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">
        ã‚µãƒ¼ãƒãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹Cookieã‚’è¨ºæ–­ã—ã¾ã™
      </p>
      
      <button id="checkServerBtn">ğŸ”„ ã‚µãƒ¼ãƒãƒ¼Cookieã‚’è¨ºæ–­</button>
      
      <div id="serverResult" style="display: none; margin-top: 20px;">
        <div class="section-title">è¨ºæ–­çµæœ</div>
        <div id="serverStatus"></div>
        <div id="serverDetails"></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 15px; color: #b0b0b0;">ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶å´CookieçŠ¶æ…‹</h2>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">
        ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹Cookieã‚’ç¢ºèªã—ã¾ã™
      </p>
      
      <button id="checkBrowserBtn">ğŸ”„ ãƒ–ãƒ©ã‚¦ã‚¶Cookieã‚’ç¢ºèª</button>
      
      <div id="browserResult" style="display: none; margin-top: 20px;">
        <div class="section-title">ãƒ–ãƒ©ã‚¦ã‚¶Cookie</div>
        <div id="browserStatus"></div>
        <div id="browserDetails"></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 15px; color: #b0b0b0;">ğŸ§ª APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ</h2>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">
        å®Ÿéš›ã®X.com APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™
      </p>
      
      <button id="testApiBtn">ğŸš€ APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ</button>
      
      <div id="apiResult" style="display: none; margin-top: 20px;">
        <div class="section-title">APIãƒ†ã‚¹ãƒˆçµæœ</div>
        <div id="apiStatus"></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 15px; color: #b0b0b0;">ğŸ“‹ ç·åˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</h2>
      <div id="summaryReport" style="display: none;">
        <ul class="checklist" id="checklistItems"></ul>
        
        <div class="section-title">æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div id="recommendations"></div>
      </div>
      
      <button id="generateReportBtn" style="background: #4CAF50;">ğŸ“„ ç·åˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
    </div>
  </div>

  <script>
    const REQUIRED_COOKIES = ['auth_token', 'ct0'];
    const RECOMMENDED_COOKIES = ['twid', 'guest_id', 'personalization_id', 'guest_id_marketing', 'guest_id_ads'];
    const OPTIONAL_COOKIES = ['kdt', 'dnt', 'd_prefs', 'lang'];

    let serverData = null;
    let browserData = null;
    let apiData = null;

    // ã‚µãƒ¼ãƒãƒ¼Cookieè¨ºæ–­
    document.getElementById('checkServerBtn').addEventListener('click', async () => {
      const btn = document.getElementById('checkServerBtn');
      const result = document.getElementById('serverResult');
      const status = document.getElementById('serverStatus');
      const details = document.getElementById('serverDetails');

      btn.disabled = true;
      btn.textContent = 'è¨ºæ–­ä¸­...';

      try {
        const response = await fetch('/api/x-cookies-debug');
        const data = await response.json();
        serverData = data;

        result.style.display = 'block';

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
        let statusClass = 'status-error';
        let statusText = 'âŒ Cookieä¸è¶³';

        if (data.success && data.cookieCount >= 10 && data.hasAuthToken && data.hasCt0) {
          statusClass = 'status-ok';
          statusText = 'âœ… Cookieæ­£å¸¸';
        } else if (data.success && data.cookieCount >= 5) {
          statusClass = 'status-warning';
          statusText = 'âš ï¸ Cookieä¸è¶³ã®å¯èƒ½æ€§';
        }

        status.innerHTML = `
          <div class="${statusClass}">
            <strong>${statusText}</strong><br>
            Cookieæ•°: <strong>${data.cookieCount || 0}</strong>å€‹<br>
            auth_token: <strong>${data.hasAuthToken ? 'âœ… ã‚ã‚Š' : 'âŒ ãªã—'}</strong><br>
            ct0: <strong>${data.hasCt0 ? 'âœ… ã‚ã‚Š' : 'âŒ ãªã—'}</strong>
          </div>
        `;

        if (data.cookies && data.cookies.length > 0) {
          let tableHTML = `
            <table class="cookie-table">
              <thead>
                <tr>
                  <th>Cookieå</th>
                  <th>çŠ¶æ…‹</th>
                  <th>æœ‰åŠ¹æœŸé™</th>
                  <th>å€¤ã®é•·ã•</th>
                </tr>
              </thead>
              <tbody>
          `;

          data.cookies.forEach(cookie => {
            const isExpired = cookie.isExpired;
            const badge = isExpired 
              ? '<span class="badge badge-expired">æœŸé™åˆ‡ã‚Œ</span>'
              : '<span class="badge badge-ok">æœ‰åŠ¹</span>';
            
            const hasValue = cookie.hasValue 
              ? `${cookie.valueLength}æ–‡å­—`
              : 'ç©º';

            tableHTML += `
              <tr>
                <td><code>${cookie.name}</code></td>
                <td>${badge}</td>
                <td>${cookie.expires || 'ã‚»ãƒƒã‚·ãƒ§ãƒ³'}</td>
                <td>${hasValue}</td>
              </tr>
            `;
          });

          tableHTML += '</tbody></table>';
          details.innerHTML = tableHTML;
        }

        btn.textContent = 'âœ… è¨ºæ–­å®Œäº†';
        btn.style.background = '#4CAF50';

      } catch (error) {
        status.innerHTML = `
          <div class="status-error">
            <strong>âŒ è¨ºæ–­ã‚¨ãƒ©ãƒ¼</strong><br>
            ${error.message}
          </div>
        `;
        result.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ ã‚µãƒ¼ãƒãƒ¼Cookieã‚’è¨ºæ–­';
      }
    });

    // ãƒ–ãƒ©ã‚¦ã‚¶Cookieç¢ºèª
    document.getElementById('checkBrowserBtn').addEventListener('click', () => {
      const btn = document.getElementById('checkBrowserBtn');
      const result = document.getElementById('browserResult');
      const status = document.getElementById('browserStatus');
      const details = document.getElementById('browserDetails');

      btn.disabled = true;
      btn.textContent = 'ç¢ºèªä¸­...';

      try {
        const cookieString = document.cookie;
        
        if (!cookieString) {
          throw new Error('ãƒ–ãƒ©ã‚¦ã‚¶ã«CookieãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        const cookiePairs = cookieString.split(';');
        const cookies = {};
        
        cookiePairs.forEach(pair => {
          const [name, value] = pair.trim().split('=');
          if (name && value) {
            cookies[name] = value;
          }
        });

        browserData = cookies;
        const count = Object.keys(cookies).length;

        result.style.display = 'block';

        const hasAuthToken = !!cookies['auth_token'];
        const hasCt0 = !!cookies['ct0'];

        let statusClass = 'status-warning';
        let statusText = 'âš ï¸ auth_tokenãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆHttpOnlyï¼‰';

        if (count >= 8 && hasCt0) {
          statusClass = 'status-ok';
          statusText = 'âœ… ãƒ–ãƒ©ã‚¦ã‚¶Cookieç¢ºèªå®Œäº†';
        } else if (count < 5) {
          statusClass = 'status-error';
          statusText = 'âŒ Cookieæ•°ãŒå°‘ãªã™ãã¾ã™';
        }

        status.innerHTML = `
          <div class="${statusClass}">
            <strong>${statusText}</strong><br>
            å–å¾—Cookieæ•°: <strong>${count}</strong>å€‹<br>
            auth_token: <strong>${hasAuthToken ? 'âœ… ã‚ã‚Š' : 'âš ï¸ ãªã— (HttpOnly)'}</strong><br>
            ct0: <strong>${hasCt0 ? 'âœ… ã‚ã‚Š' : 'âŒ ãªã—'}</strong>
          </div>
        `;

        details.innerHTML = `
          <pre>${JSON.stringify(cookies, null, 2)}</pre>
          <p style="color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 10px;">
            â„¹ï¸ auth_tokenã¯HttpOnlyã®ãŸã‚ã€document.cookieã§ã¯å–å¾—ã§ãã¾ã›ã‚“
          </p>
        `;

        btn.textContent = 'âœ… ç¢ºèªå®Œäº†';
        btn.style.background = '#4CAF50';

      } catch (error) {
        status.innerHTML = `
          <div class="status-error">
            <strong>âŒ ç¢ºèªã‚¨ãƒ©ãƒ¼</strong><br>
            ${error.message}
          </div>
        `;
        result.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ ãƒ–ãƒ©ã‚¦ã‚¶Cookieã‚’ç¢ºèª';
      }
    });

    // APIãƒ†ã‚¹ãƒˆ
    document.getElementById('testApiBtn').addEventListener('click', async () => {
      const btn = document.getElementById('testApiBtn');
      const result = document.getElementById('apiResult');
      const status = document.getElementById('apiStatus');

      btn.disabled = true;
      btn.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';

      try {
        // ã¾ãšã‚µãƒ¼ãƒãƒ¼Cookieã‚’ç¢ºèª
        const cookieCheck = await fetch('/api/x-cookies-debug');
        const cookieData = await cookieCheck.json();

        if (!cookieData.success || !cookieData.hasAuthToken) {
          throw new Error('CookieãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã¾ãšCookieã‚’æ³¨å…¥ã—ã¦ãã ã•ã„ã€‚');
        }

        // ç°¡æ˜“çš„ãªAPIãƒ†ã‚¹ãƒˆï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§X.comã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
        const testUrl = 'https://api.x.com/1.1/account/verify_credentials.json';
        const encodedUrl = btoa(testUrl).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        
        const apiResponse = await fetch(`/proxy/${encodedUrl}`, {
          method: 'GET',
          credentials: 'include'
        });

        apiData = {
          status: apiResponse.status,
          ok: apiResponse.ok
        };

        result.style.display = 'block';

        if (apiResponse.ok) {
          status.innerHTML = `
            <div class="status-ok">
              <strong>âœ… APIå‘¼ã³å‡ºã—æˆåŠŸ</strong><br>
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${apiResponse.status}<br>
              èªè¨¼ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã—ã¦ã„ã¾ã™
            </div>
          `;
        } else {
          const errorText = await apiResponse.text();
          status.innerHTML = `
            <div class="status-error">
              <strong>âŒ APIå‘¼ã³å‡ºã—å¤±æ•—</strong><br>
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${apiResponse.status}<br>
              ã‚¨ãƒ©ãƒ¼: ${errorText.substring(0, 200)}...
            </div>
          `;
        }

        btn.textContent = 'âœ… ãƒ†ã‚¹ãƒˆå®Œäº†';
        btn.style.background = apiResponse.ok ? '#4CAF50' : '#f44336';

      } catch (error) {
        status.innerHTML = `
          <div class="status-error">
            <strong>âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼</strong><br>
            ${error.message}
          </div>
        `;
        result.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'ğŸš€ APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ';
      }
    });

    // ç·åˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    document.getElementById('generateReportBtn').addEventListener('click', () => {
      const report = document.getElementById('summaryReport');
      const checklist = document.getElementById('checklistItems');
      const recommendations = document.getElementById('recommendations');

      if (!serverData) {
        alert('ã¾ãšã€Œã‚µãƒ¼ãƒãƒ¼Cookieã‚’è¨ºæ–­ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }

      report.style.display = 'block';

      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç”Ÿæˆ
      const checks = [
        {
          label: 'ã‚µãƒ¼ãƒãƒ¼ã«CookieãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹',
          ok: serverData && serverData.success && serverData.cookieCount > 0,
          critical: true
        },
        {
          label: 'auth_tokenãŒå­˜åœ¨ã™ã‚‹',
          ok: serverData && serverData.hasAuthToken,
          critical: true
        },
        {
          label: 'ct0ãŒå­˜åœ¨ã™ã‚‹',
          ok: serverData && serverData.hasCt0,
          critical: true
        },
        {
          label: 'Cookieæ•°ãŒ10å€‹ä»¥ä¸Š',
          ok: serverData && serverData.cookieCount >= 10,
          critical: false
        },
        {
          label: 'CookieãŒæœ‰åŠ¹æœŸé™å†…',
          ok: serverData && serverData.cookies && !serverData.cookies.some(c => c.isExpired),
          critical: true
        }
      ];

      let checklistHTML = '';
      let failedCritical = [];

      checks.forEach(check => {
        const className = check.ok ? 'ok' : (check.critical ? 'error' : 'warning');
        const icon = check.ok ? 'âœ…' : (check.critical ? 'âŒ' : 'âš ï¸');
        
        checklistHTML += `<li class="${className}">${icon} ${check.label}</li>`;
        
        if (!check.ok && check.critical) {
          failedCritical.push(check.label);
        }
      });

      checklist.innerHTML = checklistHTML;

      // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      let recommendHTML = '';

      if (failedCritical.length > 0) {
        recommendHTML = `
          <div class="status-error">
            <strong>ğŸš¨ ç·Šæ€¥: ä»¥ä¸‹ã®å•é¡Œã‚’è§£æ±ºã—ã¦ãã ã•ã„</strong><br><br>
            ${failedCritical.map(item => `â€¢ ${item}`).join('<br>')}
            <br><br>
            <strong>è§£æ±ºç­–:</strong><br>
            1. Cookie Helperã§å…¨ã¦ã®Cookieã‚’å†æ³¨å…¥<br>
            2. ç‰¹ã«auth_tokenã¨ct0ã‚’å¿…ãšå«ã‚ã‚‹<br>
            3. X.comã§æ–°ã—ã„Cookieã‚’å–å¾—ã™ã‚‹
          </div>
        `;
      } else if (!serverData || serverData.cookieCount < 10) {
        recommendHTML = `
          <div class="status-warning">
            <strong>âš ï¸ Cookieæ•°ã‚’å¢—ã‚„ã™ã“ã¨ã‚’æ¨å¥¨</strong><br><br>
            ç¾åœ¨: ${serverData ? serverData.cookieCount : 0}å€‹<br>
            æ¨å¥¨: 12å€‹ä»¥ä¸Š<br><br>
            <strong>è¿½åŠ æ¨å¥¨Cookie:</strong><br>
            â€¢ guest_id<br>
            â€¢ personalization_id<br>
            â€¢ guest_id_marketing<br>
            â€¢ guest_id_ads<br>
            â€¢ twid
          </div>
        `;
      } else {
        recommendHTML = `
          <div class="status-ok">
            <strong>âœ… Cookieã®çŠ¶æ…‹ã¯è‰¯å¥½ã§ã™</strong><br><br>
            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:<br>
            1. /home ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚’ãƒ†ã‚¹ãƒˆ<br>
            2. ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª<br>
            3. ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã‚µãƒãƒ¼ãƒˆã«å ±å‘Š
          </div>
        `;
      }

      recommendations.innerHTML = recommendHTML;
    });
  </script>
</body>
</html> 